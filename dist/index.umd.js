!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("path"),require("chalk"),require("lodash"),require("ali-oss"),require("cos-nodejs-sdk-v5"),require("buffer"),require("zlib"),require("vite"),require("glob"),require("fs")):"function"==typeof define&&define.amd?define(["exports","path","chalk","lodash","ali-oss","cos-nodejs-sdk-v5","buffer","zlib","vite","glob","fs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vitepluginossplus={},e.path,e.chalk,e.lodash,e.AliOSS,e.COS,e.buffer,e.zlib,e.vite,e.glob,e.fs)}(this,(function(e,t,n,o,i,r,c,l,a,u,s){"use strict";function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=f(t),p=f(n),h=f(i),g=f(r),v=f(l),y=f(u);function S(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function l(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,l)}a((o=o.apply(e,t||[])).next())}))}function b(e,t){var n,o,i,r,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function l(l){return function(a){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,l[0]&&(c=0)),c;)try{if(n=1,o&&(i=2&l[0]?o.return:l[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,l[1])).done)return i;switch(o=0,i&&(l=[2&l[0],i.value]),l[0]){case 0:case 1:i=l;break;case 4:return c.label++,{value:l[1],done:!1};case 5:c.label++,o=l[1],l=[0];continue;case 7:l=c.ops.pop(),c.trys.pop();continue;default:if(!(i=c.trys,(i=i.length>0&&i[i.length-1])||6!==l[0]&&2!==l[0])){c=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3])){c.label=l[1];break}if(6===l[0]&&c.label<i[1]){c.label=i[1],i=l;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(l);break}i[2]&&c.ops.pop(),c.trys.pop();continue}l=t.call(e,c)}catch(e){l=[6,e],o=0}finally{n=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,a])}}}function m(e,t,n){if(n||2===arguments.length)for(var o,i=0,r=t.length;i<r;i++)!o&&i in t||(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}function O(e,t){return t?new Promise((function(t,n){v.default.gzip(c.Buffer.from(e.content),{},(function(e,o){e&&n(e),t(o)}))})):Promise.resolve(c.Buffer.from(e.content))}function P(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.log.apply(console,m([p.default.bgMagenta("[vite-plugin-ossplus]:")],e,!1))}var k,w={provider:{},retry:3,existCheck:!0,ossBaseDir:"auto_upload_ci",project:"",exclude:/.*\.html$/,include:/.*/,enableLog:!1,ignoreError:!1,gzip:!0},F=p.default.red,x=p.default.bold.green,j=p.default.yellow;!function(e){e[e.AliOSS=0]="AliOSS",e[e.QCloudOSS=1]="QCloudOSS"}(k||(k={}));var q=function(){function e(e){this.config=w,this.client={},this.finalPrefix="",this.currentProvider={},this.config=o.mergeWith(o.cloneDeep(this.config),e||{},(function(e,t){return o.isPlainObject(e)&&o.isPlainObject(t)?o.merge(e,t):t}));var t=this.config,n=t.retry,i=t.provider,r=t.ossBaseDir,c=t.project;if(("number"!=typeof n||n<0)&&(this.config.retry=0),this.finalPrefix="".concat(r,"/").concat(c),this.debug("默认配置:",w),this.debug("项目配置:",e),this.debug("最终使用的配置:",this.config),void 0!==i.aliOSS){this.currentProvider=i.aliOSS,this.providerType=k.AliOSS;var l=i.aliOSS,a=l.accessKeyId,u=l.accessKeySecret,s=l.bucket,f=l.region;this.client=h.default({accessKeyId:a,accessKeySecret:u,bucket:s,region:f})}else if(void 0!==i.qcloudOS){this.currentProvider=i.qcloudOS,this.providerType=k.QCloudOSS;var d=i.qcloudOS,p=d.SecretId,v=d.SecretKey;this.client=new g.default({SecretId:p,SecretKey:v})}}return e.prototype.pickupAssetsFile=function(e,t){for(var n,o,i=[],r=0;r<e.length;r++){var c=e[r],l=c.split(t)[1];(null===(n=this.config.exclude)||void 0===n?void 0:n.test(l))||(null===(o=this.config.include)||void 0===o?void 0:o.test(l))&&i.push({name:l,path:c,content:s.readFileSync(c,{encoding:null})})}return i},e.prototype.hanleFilesUpload=function(e,t){var n=this,o=this.pickupAssetsFile(e,t);0!==o.length?(P("".concat(x("\nOSS 上传开始......"))),this.batchUploadFiles(o).then((function(){P("".concat(x("OSS 上传完成\n")))})).catch((function(e){if(P("".concat(F("OSS 上传出错"),"::: ").concat(F(e.code),"-").concat(F(e.name),": ").concat(F(e.message))),!n.config.ignoreError)throw Error("OSS 上传出错")}))):function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.warn.apply(console,m([p.default.bgMagenta("[vite-plugin-ossplus]:")],e,!1))}("".concat(j("\n 没有找到符合条件的文件上传，请检测配置信息！")))},e.prototype.batchUploadFiles=function(e){var t=this,n=1;return Promise.all(o.map(e,(function(o){var i;return o.$retryTime=0,i="/"===d.default.sep?d.default.join(t.finalPrefix,o.name):d.default.join(t.finalPrefix,o.name).split(d.default.sep).join("/"),t.config.existCheck?t.checkOSSFile(o,n++,e,i):t.uploadFile(o,n++,e,i)})))},e.prototype.uploadFile=function(e,t,n,o){return this.providerType===k.AliOSS?this.aliUploadFile(e,t,n,o):this.providerType===k.QCloudOSS?this.qcloudUploadFile(e,t,n,o):Promise.reject("没有找到上传SDK!")},e.prototype.aliUploadFile=function(e,t,n,o){var i=this;return new Promise((function(r,c){var l=n.length;O(e,i.config.gzip).then((function(n){var a=i.getOSSUploadOptions(),u=i;!function i(){e.$retryTime++,P("开始上传 ".concat(t,"/").concat(l,": ").concat(e.$retryTime>1?"第".concat(e.$retryTime-1,"次重试"):""),o),u.client.put(o,n,a).then((function(e){P("上传成功 ".concat(t,"/").concat(l,": ").concat(o)),r(e)})).catch((function(t){e.$retryTime<u.config.retry+1?i():c(t)}))}()})).catch((function(e){c(e)}))}))},e.prototype.qcloudUploadFile=function(e,t,n,o){var i=this;return new Promise((function(r,c){var l=n.length;O(e,i.config.gzip).then((function(n){var a=i;!function i(){e.$retryTime++,P("开始上传 ".concat(t,"/").concat(l,": ").concat(e.$retryTime>1?"第".concat(e.$retryTime-1,"次重试"):""),o),a.client.putObject({Bucket:a.currentProvider.Bucket,Region:a.currentProvider.Region,Key:o,Body:n},(function(n,u){n?e.$retryTime<a.config.retry+1?i():c(n):(P("上传成功 ".concat(t,"/").concat(l,": ").concat(o)),r(u))}))}()})).catch((function(e){c(e)}))}))},e.prototype.checkOSSFile=function(e,t,n,o){return this.providerType===k.AliOSS?this.aliCheckOSSFile(e,t,n,o):this.providerType===k.QCloudOSS?this.qcloudCheckOSSFile(e,t,n,o):Promise.reject("检测OSS文件失败！")},e.prototype.aliCheckOSSFile=function(e,t,n,o){var i=this;return new Promise((function(r,c){i.client.list({prefix:o,"max-keys":50}).then((function(e){var i=(e.objects||[]).filter((function(e){return e.name===o}));if(!(i&&i.length>0))throw new Error("not exist & need upload");var c,l=(c=new Date(e.objects[0].lastModified),"".concat(c.getFullYear(),"-").concat(c.getMonth()+1,"-").concat(c.getDate()," ").concat(c.getHours(),":").concat(c.getMinutes()));P("".concat(x("已存在,免上传")," (上传于 ").concat(l,") ").concat(t,"/").concat(n.length,": ").concat(o)),r(e)})).catch((function(l){i.uploadFile(e,t,n,o).then((function(e){r(e)})).catch((function(e){c(e)}))}))}))},e.prototype.qcloudCheckOSSFile=function(e,t,n,o){var i=this;return new Promise((function(r,c){i.client.headObject({Bucket:i.currentProvider.Bucket,Region:i.currentProvider.Region,key:o},(function(l,a){a?(P("".concat(x("已存在,免上传")," ").concat(t,"/").concat(n.length,": ").concat(o)),r(a)):(404==l.statusCode?console.log("对象不存在"):403==l.statusCode&&console.log("没有该对象读权限"),i.qcloudUploadFile(e,t,n,o).then((function(e){r(e)})).catch((function(e){c(e)})))}))}))},e.prototype.getOSSUploadOptions=function(){var e=this.currentProvider.options;return this.config.gzip?e?(e.headers["Content-Encoding"]="gzip",e):{headers:{"Content-Encoding":"gzip"}}:e||void 0},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.config.enableLog&&P.apply(void 0,e)},e}();e.ViteOSSPlusPluginCore=q,e.default=function(e){var n,o=new q(e);return{name:"vite-plugin-ossplus",enforce:"post",apply:"build",configResolved:function(e){n=e.build},closeBundle:function(){return S(this,void 0,void 0,(function(){var e,i;return b(this,(function(r){switch(r.label){case 0:return e=a.normalizePath(t.resolve(a.normalizePath(n.outDir))),[4,y.default.sync("".concat(e,"/**/*"),{nodir:!0,dot:!0})];case 1:return i=r.sent(),o.hanleFilesUpload(i,e),[2]}}))}))}}},Object.defineProperty(e,"__esModule",{value:!0})}));
